<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Grafik Irigasi Otomatis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    canvas { margin-bottom: 40px; max-width: 100%; height: auto; }
    h3 { margin-top: 50px; }
  </style>
</head>
<body>
  <h2>ðŸ“ˆ Grafik Irigasi Otomatis</h2>

  <h3>Real-time (Perdetik)</h3>
  <canvas id="kelembabanRealtime"></canvas>
  <canvas id="airRealtime"></canvas>
  <canvas id="volumeRealtime"></canvas>

  <h3>Rata-rata Per Hari (Hari Ini)</h3>
  <canvas id="dailyAvgChart"></canvas>

  <h3>Rata-rata Per Minggu (7 Hari Terakhir)</h3>
  <canvas id="weeklyAvgChart"></canvas>

  <script>
    // Inisialisasi Firebase
    const firebaseConfig = {
      databaseURL: "https://irigasi-9a2b9-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const dataRef = firebase.database().ref("IrigasiOtomatis/Data");

    // Utility Chart Builder
    const createChart = (ctx, label, color) => new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ label, data: [], borderColor: color, fill: false, tension: 0.2 }] },
      options: { scales: { x: { title: { display: true, text: 'Waktu' } }, y: { beginAtZero: true } } }
    });

    // Chart Real-time
    const kelembabanChart = createChart(document.getElementById('kelembabanRealtime'), 'Kelembaban Tanah (%)', 'green');
    const airChart = createChart(document.getElementById('airRealtime'), 'Ketinggian Air (cm)', 'blue');
    const volumeChart = createChart(document.getElementById('volumeRealtime'), 'Volume Aktual (L)', 'orange');

    const addData = (chart, label, value) => {
      chart.data.labels.push(label);
      chart.data.datasets[0].data.push(value);
      if (chart.data.labels.length > 20) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update();
    };

    // Realtime update
    dataRef.on('value', snapshot => {
      const data = snapshot.val();
      const now = new Date();
      const label = now.toLocaleTimeString('id-ID');

      if (data) {
        addData(kelembabanChart, label, data.KelembabanTanah || 0);
        addData(airChart, label, data.KetinggianAir || 0);
        addData(volumeChart, label, data.VolumeAktual || 0);
      }
    });

    // Data Historis (rata-rata harian dan mingguan)
    const dailyAvgChart = new Chart(document.getElementById('dailyAvgChart'), {
      type: 'bar',
      data: {
        labels: [],
        datasets: [
          { label: 'Kelembaban (%)', data: [], backgroundColor: 'green' },
          { label: 'Ketinggian Air (cm)', data: [], backgroundColor: 'blue' },
          { label: 'Volume (L)', data: [], backgroundColor: 'orange' }
        ]
      },
      options: {
        responsive: true,
        scales: { x: { stacked: true }, y: { beginAtZero: true } }
      }
    });

    const weeklyAvgChart = new Chart(document.getElementById('weeklyAvgChart'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'Kelembaban (%)', data: [], borderColor: 'green', fill: false },
          { label: 'Ketinggian Air (cm)', data: [], borderColor: 'blue', fill: false },
          { label: 'Volume (L)', data: [], borderColor: 'orange', fill: false }
        ]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    // Ambil data historis dari path yang sama
    dataRef.parent.on('value', (snapshot) => {
      const allData = snapshot.val();
      const daily = {}, weekly = {};

      const now = new Date();
      const today = now.toISOString().split('T')[0];

      for (let key in allData.DataHistory || {}) {
        const entry = allData.DataHistory[key];
        const time = new Date(entry.timestamp);
        const dateStr = time.toISOString().split('T')[0];

        // Daily (hari ini)
        if (dateStr === today) {
          const hour = time.getHours();
          if (!daily[hour]) daily[hour] = { kelembaban: 0, air: 0, volume: 0, count: 0 };
          daily[hour].kelembaban += entry.KelembabanTanah || 0;
          daily[hour].air += entry.KetinggianAir || 0;
          daily[hour].volume += entry.VolumeAktual || 0;
          daily[hour].count++;
        }

        // Weekly
        const diffDays = (now - time) / (1000 * 60 * 60 * 24);
        if (diffDays <= 7) {
          if (!weekly[dateStr]) weekly[dateStr] = { kelembaban: 0, air: 0, volume: 0, count: 0 };
          weekly[dateStr].kelembaban += entry.KelembabanTanah || 0;
          weekly[dateStr].air += entry.KetinggianAir || 0;
          weekly[dateStr].volume += entry.VolumeAktual || 0;
          weekly[dateStr].count++;
        }
      }

      // Tampilkan rata-rata harian
      dailyAvgChart.data.labels = [];
      dailyAvgChart.data.datasets.forEach(ds => ds.data = []);
      for (let hour in daily) {
        dailyAvgChart.data.labels.push(`${hour}:00`);
        dailyAvgChart.data.datasets[0].data.push((daily[hour].kelembaban / daily[hour].count).toFixed(2));
        dailyAvgChart.data.datasets[1].data.push((daily[hour].air / daily[hour].count).toFixed(2));
        dailyAvgChart.data.datasets[2].data.push((daily[hour].volume / daily[hour].count).toFixed(2));
      }
      dailyAvgChart.update();

      // Tampilkan rata-rata mingguan
      weeklyAvgChart.data.labels = [];
      weeklyAvgChart.data.datasets.forEach(ds => ds.data = []);
      const sortedWeekly = Object.keys(weekly).sort();
      for (let d of sortedWeekly) {
        weeklyAvgChart.data.labels.push(d);
        weeklyAvgChart.data.datasets[0].data.push((weekly[d].kelembaban / weekly[d].count).toFixed(2));
        weeklyAvgChart.data.datasets[1].data.push((weekly[d].air / weekly[d].count).toFixed(2));
        weeklyAvgChart.data.datasets[2].data.push((weekly[d].volume / weekly[d].count).toFixed(2));
      }
      weeklyAvgChart.update();
    });
  </script>
</body>
</html>



