<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Grafik Irigasi Otomatis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    body{font-family:Arial, sans-serif;padding:20px;}
    canvas{margin-bottom:40px;max-width:100%;height:auto;}
    button{margin-right:10px;margin-bottom:20px;}
  </style>
</head>
<body>
  <h2>ðŸ“ˆÂ Grafik Irigasi Otomatis</h2>
  <div>
    <button onclick="loadRealtime()">Realtime (perâ€¯Detik)</button>
    <button onclick="loadToday()">HariÂ Ini (semuaÂ waktu)</button>
  </div>
  <canvas id="kelembabanChart"></canvas>
  <canvas id="airChart"></canvas>
  <canvas id="volumeChart"></canvas>

<script>
  /* ---------- 1. Inisialisasi Firebase ---------- */
  const firebaseConfig={databaseURL:"https://irigasi-9a2b9-default-rtdb.firebaseio.com/"};
  firebase.initializeApp(firebaseConfig);
  const dataRef = firebase.database().ref("IrigasiOtomatis/Data");

  /* ---------- 2. Buat 3 chart ---------- */
  const kelembaban = makeChart('kelembabanChart','KelembabanÂ TanahÂ (%)','green');
  const air        = makeChart('airChart','KetinggianÂ AirÂ (cm)','blue');
  const volume     = makeChart('volumeChart','VolumeÂ AktualÂ (L)','orange');

  function makeChart(canvasId,label,color){
    return new Chart(document.getElementById(canvasId).getContext('2d'),{
      type:'line',
      data:{labels:[],datasets:[{label,data:[],borderColor:color,fill:false,tension:0.25}]},
      options:{scales:{y:{beginAtZero:true},x:{title:{display:true,text:'Waktu'}}}}
    });
  }
  function updateChart(chart,labels,values){
    chart.data.labels=labels;
    chart.data.datasets[0].data=values;
    chart.update();
  }

  /* ---------- 3. Realtime (push per detik) ---------- */
  let listener=null;
  function loadRealtime(){
    removeListener();
    clearAllCharts();
    listener = dataRef.on('value',snap=>{
      const entry = snap.val();
      if(!entry) return;
      const ts = entry.timestamp ?? Date.now();                // fallback: now
      const tLabel = new Date(ts).toLocaleTimeString('id-ID');

      pushPoint(kelembaban,tLabel,entry.KelembabanTanah||0);
      pushPoint(air       ,tLabel,entry.KetinggianAir ||0);
      pushPoint(volume    ,tLabel,entry.VolumeAktual   ||0);
    });
  }
  function pushPoint(chart,label,val){
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(val);
    if(chart.data.labels.length>100) {      // simpan max 100 titik agar tidak berat
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.update();
  }

  /* ---------- 4. Hari ini (ambil snapshot sekali, filter tanggal) ---------- */
  async function loadToday(){
    removeListener();
    clearAllCharts();

    const snap = await dataRef.once('value');
    const all  = snap.val() || {};

    const todayStr = new Date().toLocaleDateString('id-ID');
    const lab = [], kArr=[], aArr=[], vArr=[];

    Object.entries(all).forEach(([key,val])=>{
      const ts = getTimestamp(key,val);
      if(!ts) return;
      const d  = new Date(ts);
      if(d.toLocaleDateString('id-ID')!==todayStr) return;   // skip kalau bukan hari ini

      lab.push(d.toLocaleTimeString('id-ID'));
      kArr.push(val.KelembabanTanah||0);
      aArr.push(val.KetinggianAir ||0);
      vArr.push(val.VolumeAktual  ||0);
    });

    updateChart(kelembaban,lab,kArr);
    updateChart(air       ,lab,aArr);
    updateChart(volume    ,lab,vArr);
  }

  /* ---------- 5. Util ---------- */
  function removeListener(){
    if(listener){ dataRef.off('value',listener); listener=null; }
  }
  function clearAllCharts(){
    [kelembaban,air,volume].forEach(c=>{
      c.data.labels=[]; c.data.datasets[0].data=[]; c.update();
    });
  }
  // Mengambil timestamp dari field atau dari key
  function getTimestamp(key,obj){
    if(obj.timestamp) return obj.timestamp;
    // contoh key "2025-07-26_10:30:12"
    const re=/(\d{4})-(\d{2})-(\d{2})_(\d{2}):(\d{2}):(\d{2})/;
    const m=key.match(re);
    if(!m) return null;
    return new Date(`${m[1]}-${m[2]}-${m[3]}T${m[4]}:${m[5]}:${m[6]}+07:00`).getTime();
  }

  /* ---------- 6. Mulai dengan realtime ---------- */
  loadRealtime();
</script>
</body>
</html>




