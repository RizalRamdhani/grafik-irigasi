<script>
  const firebaseConfig = { databaseURL: "https://irigasi-9a2b9-default-rtdb.firebaseio.com/" };
  firebase.initializeApp(firebaseConfig);
  const rootRef = firebase.database().ref("IrigasiOtomatis/Data");

  const kelembaban = createChart(document.getElementById('kelembabanChart').getContext('2d'), 'Kelembaban Tanah (%)', 'green');
  const air = createChart(document.getElementById('airChart').getContext('2d'), 'Ketinggian Air (cm)', 'blue');
  const volume = createChart(document.getElementById('volumeChart').getContext('2d'), 'Volume Aktual (L)', 'orange');

  function createChart(ctx, label, color) {
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{ label, data: [], borderColor: color, backgroundColor: color + '33', fill: true, tension: 0.3 }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true }, tooltip: { mode: 'index', intersect: false } },
        scales: {
          x: { title: { display: true, text: 'Waktu' } },
          y: { beginAtZero: true }
        }
      }
    });
  }

  function clearChart(chart) {
    chart.data.labels = [];
    chart.data.datasets[0].data = [];
    chart.update();
  }

  function loadData(mode) {
    clearChart(kelembaban);
    clearChart(air);
    clearChart(volume);

    const now = new Date();
    const targetDates = [];

    if (mode === 'daily') {
      targetDates.push(now.toISOString().split('T')[0]);
    } else if (mode === 'weekly') {
      for (let i = 6; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        targetDates.push(d.toISOString().split('T')[0]);
      }
    }

    rootRef.once('value', snap => {
      const allData = snap.val();
      if (!allData) return;

      Object.values(allData).forEach(entry => {
        const tanggal = entry.TimestampTanggal;
        const jam = entry.TimestampJam;
        const waktu = `${tanggal} ${jam}`;

        if (targetDates.includes(tanggal)) {
          kelembaban.data.labels.push(waktu);
          kelembaban.data.datasets[0].data.push(entry.KelembabanTanah ?? 0);

          air.data.labels.push(waktu);
          air.data.datasets[0].data.push(entry.KetinggianAir ?? 0);

          volume.data.labels.push(waktu);
          volume.data.datasets[0].data.push(entry.VolumeAktual ?? 0);
        }
      });

      kelembaban.update();
      air.update();
      volume.update();
    });
  }

  loadData('daily'); // default
</script>


