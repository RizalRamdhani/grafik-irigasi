<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Grafik Irigasi Otomatis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    canvas { margin-bottom: 40px; max-width: 100%; height: auto; }
    button { margin-right: 10px; }
  </style>
</head>
<body>
  <h2>ðŸ“ˆ Grafik Irigasi Otomatis</h2>
  <button onclick="loadData('daily')">Per Hari</button>
  <button onclick="loadData('weekly')">Per Minggu</button>
  <canvas id="kelembabanChart"></canvas>
  <canvas id="airChart"></canvas>
  <canvas id="volumeChart"></canvas>

  <script>
    const firebaseConfig = { databaseURL: "https://irigasi-9a2b9-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const rootRef = firebase.database().ref("IrigasiOtomatis/Data");

    const kelembaban = createChart(document.getElementById('kelembabanChart').getContext('2d'), 'Kelembaban Tanah (%)', 'green');
    const air = createChart(document.getElementById('airChart').getContext('2d'), 'Ketinggian Air (cm)', 'blue');
    const volume = createChart(document.getElementById('volumeChart').getContext('2d'), 'Volume Aktual (L)', 'orange');

    function createChart(ctx, label, color) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{ label, data: [], borderColor: color, fill: false, tension: 0.2 }]
        },
        options: {
          scales: {
            x: { title: { display: true, text: 'Waktu' } },
            y: { beginAtZero: true }
          }
        }
      });
    }

    function clearChart(chart) {
      chart.data.labels = [];
      chart.data.datasets[0].data = [];
      chart.update();
    }

    function loadData(mode) {
      clearChart(kelembaban);
      clearChart(air);
      clearChart(volume);

      const now = new Date();
      const datesToFetch = [];

      if (mode === 'daily') {
        const today = now.toISOString().split('T')[0];
        datesToFetch.push(today);
      } else if (mode === 'weekly') {
        for (let i = 6; i >= 0; i--) {
          const d = new Date(now);
          d.setDate(d.getDate() - i);
          datesToFetch.push(d.toISOString().split('T')[0]);
        }
      }

      datesToFetch.forEach(dateStr => {
        rootRef.child(dateStr).once('value', snap => {
          const data = snap.val();
          if (data) {
            Object.entries(data).forEach(([time, val]) => {
              const label = `${dateStr} ${time}`;
              kelembaban.data.labels.push(label);
              kelembaban.data.datasets[0].data.push(val.KelembabanTanah || 0);

              air.data.labels.push(label);
              air.data.datasets[0].data.push(val.KetinggianAir || 0);

              volume.data.labels.push(label);
              volume.data.datasets[0].data.push(val.VolumeAktual || 0);
            });

            kelembaban.update();
            air.update();
            volume.update();
          }
        });
      });
    }

    // Load daily data by default
    loadData('daily');
  </script>
</body>
</html>

